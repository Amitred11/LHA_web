<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>canvas_white_mosaic_v2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body {
            background-color: #ffffff;
            margin: 0;
            overflow: hidden;
            user-select: none;
            font-family: 'Inter', sans-serif;
        }

        /* The Grid */
        #gridContainer {
            display: grid;
            width: 100vw;
            height: 100vh;
            /* Fixed grid 50x30 */
            grid-template-columns: repeat(50, 1fr);
            grid-template-rows: repeat(30, 1fr);
            border-top: 1px solid #f3f3f3;
            border-left: 1px solid #f3f3f3;
        }

        .pixel {
            border-right: 1px solid #f9f9f9;
            border-bottom: 1px solid #f9f9f9;
            background-color: white;
            position: relative;
            cursor: crosshair;
            background-repeat: no-repeat;
        }

        /* Selection Visuals */
        .pixel.selected::after {
            content: '';
            position: absolute;
            inset: 0;
            background-color: rgba(59, 130, 246, 0.4);
            z-index: 20;
            pointer-events: none;
        }

        /* Occupied State */
        .pixel.occupied {
            border: none;
        }

        /* --- UI ELEMENTS --- */

        /* Top Left Trigger Zone */
        .menu-container {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 100;
        }

        /* The Current Mode Icon (Always Visible) */
        .current-mode-btn {
            background: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: 1px solid #eee;
            cursor: pointer;
            transition: all 0.2s;
            color: #333;
        }
        
        .current-mode-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }

        /* The Tool Dock (Hidden by default) */
        .tool-dock {
            position: absolute;
            top: 0;
            left: 50px; /* To the right of the button */
            background: white;
            padding: 4px;
            border-radius: 50px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            border: 1px solid #eee;
            display: flex;
            gap: 4px;
            
            /* Hidden State */
            opacity: 0;
            transform: translateX(-10px);
            pointer-events: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Reveal Logic: Show dock when hovering container */
        .menu-container:hover .tool-dock {
            opacity: 1;
            transform: translateX(0);
            pointer-events: auto;
        }

        .tool-btn {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            color: #666;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
        }

        .tool-btn:hover { background: #f5f5f5; color: #333; }
        .tool-btn.active { background: #000; color: #fff; }

        /* Action Bar (Bottom) */
        .action-float {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(150px);
            background: white;
            padding: 12px 24px;
            border-radius: 50px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.12);
            border: 1px solid #eee;
            display: flex;
            align-items: center;
            gap: 20px;
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 100;
        }
        .action-float.visible { transform: translateX(-50%) translateY(0); }

        .credits-corner {
            position: fixed;
            top: 20px;
            right: 20px;
            font-size: 12px;
            color: #999;
            cursor: pointer;
            z-index: 50;
            font-weight: 600;
        }

        .minimal-input {
            width: 100%;
            border: 1px solid #eee;
            background: #fafafa;
            border-radius: 8px;
            padding: 10px;
            outline: none;
            font-size: 13px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>

    <!-- Menu Container (Hover to reveal tools) -->
    <div class="menu-container">
        <!-- Always visible icon showing current state -->
        <div class="current-mode-btn" id="currentModeIcon">
            <i class="fas fa-image"></i>
        </div>

        <!-- Hidden Dock -->
        <div class="tool-dock">
            <div class="tool-btn active" onclick="setMode('image')" id="btnImage">
                <i class="fas fa-image"></i> Photo
            </div>
            <div class="tool-btn" onclick="setMode('draw')" id="btnDraw">
                <i class="fas fa-paint-brush"></i> Brush
            </div>
        </div>
    </div>

    <div class="credits-corner" onclick="mineCredits()">
        <span id="creditCount">0</span> CR
    </div>

    <!-- Grid -->
    <div id="gridContainer"></div>

    <!-- Action Bar -->
    <div id="actionBar" class="action-float">
        <div class="text-sm font-medium text-gray-500">
            <span id="selCount">0</span> selected
        </div>
        <div class="h-4 w-px bg-gray-200"></div>
        <div class="text-sm font-bold text-black">
            <span id="costDisplay">0</span> CR
        </div>
        <button onclick="openModal()" class="bg-black text-white px-6 py-2 rounded-full text-xs font-bold hover:bg-gray-800 transition-colors">
            BUY
        </button>
        <button onclick="clearSelection()" class="text-gray-400 hover:text-red-500 text-xs px-2">
            <i class="fas fa-times"></i>
        </button>
    </div>

    <!-- Modal -->
    <div id="modal" class="fixed inset-0 bg-white/90 z-[200] hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white w-[380px] p-8 rounded-2xl shadow-2xl border border-gray-100 text-center relative">
            <h2 class="text-xl font-bold mb-2" id="modalTitle">Configure Pixels</h2>
            <p class="text-xs text-gray-400 mb-6">Total Cost: <span id="modalCost">0</span> CR</p>
            
            <!-- Image Options -->
            <div id="imageOptions" class="hidden">
                <div class="mb-4 text-left">
                    <label class="block text-xs font-bold text-gray-500 mb-1">Upload Photo (Stretched)</label>
                    <input type="file" id="fileInput" accept="image/*" class="minimal-input">
                </div>
                <div class="relative flex py-2 items-center">
                    <div class="flex-grow border-t border-gray-200"></div>
                    <span class="flex-shrink-0 mx-4 text-gray-300 text-xs">OR URL</span>
                    <div class="flex-grow border-t border-gray-200"></div>
                </div>
                <input type="text" id="urlInput" class="minimal-input" placeholder="https://example.com/image.jpg">
                <input type="text" id="linkInput" class="minimal-input" placeholder="Link (Optional)">
            </div>

            <!-- Draw Options -->
            <div id="drawOptions" class="hidden">
                <label class="block text-xs font-bold text-gray-500 mb-2 text-left">Select Color</label>
                <input type="color" id="colorInput" class="w-full h-12 cursor-pointer bg-gray-50 border rounded-lg p-1" value="#000000">
            </div>

            <div class="flex gap-3 justify-center mt-6">
                <button onclick="closeModal()" class="px-6 py-2 rounded-full text-xs font-bold text-gray-500 hover:bg-gray-100">Cancel</button>
                <button onclick="confirmPurchase()" class="px-6 py-2 rounded-full text-xs font-bold bg-black text-white hover:scale-105 transition-transform shadow-lg">Confirm</button>
            </div>
        </div>
    </div>

    <script>
        const COLS = 50;
        const ROWS = 30;
        const COST_PER_PIXEL = 10;
        
        let credits = parseInt(localStorage.getItem('w3_credits')) || 500;
        let gridData = JSON.parse(localStorage.getItem('w3_grid')) || {};
        let selectedIndices = new Set();
        let isDragging = false;
        let currentMode = 'image';
        let dragStartIdx = null;

        const grid = document.getElementById('gridContainer');
        const actionBar = document.getElementById('actionBar');
        const fileInput = document.getElementById('fileInput');
        const currentModeIcon = document.getElementById('currentModeIcon');

        function init() {
            renderGrid();
            updateCredits();
            setMode('image');
        }

        function setMode(mode) {
            currentMode = mode;
            
            // Update Menu UI
            document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
            if(mode === 'image') {
                document.getElementById('btnImage').classList.add('active');
                currentModeIcon.innerHTML = '<i class="fas fa-image"></i>';
            }
            if(mode === 'draw') {
                document.getElementById('btnDraw').classList.add('active');
                currentModeIcon.innerHTML = '<i class="fas fa-paint-brush"></i>';
            }
            
            clearSelection();
        }

        function updateCredits() {
            document.getElementById('creditCount').innerText = credits;
            localStorage.setItem('w3_credits', credits);
        }

        function mineCredits() {
            credits += 50;
            updateCredits();
        }

        function renderGrid() {
            grid.innerHTML = '';
            const total = COLS * ROWS;
            for(let i=0; i<total; i++) {
                const div = document.createElement('div');
                div.className = 'pixel';
                div.dataset.index = i;
                if(gridData[i]) renderCell(div, gridData[i]);

                div.addEventListener('mousedown', (e) => startDrag(e, i));
                div.addEventListener('mouseenter', (e) => onDrag(e, i));
                div.addEventListener('click', (e) => {
                    if(!isDragging && gridData[i]?.link) window.open(gridData[i].link, '_blank');
                });
                grid.appendChild(div);
            }
            window.addEventListener('mouseup', endDrag);
        }

        function renderCell(div, data) {
            div.classList.add('occupied');
            div.innerHTML = '';
            div.style.backgroundColor = '';
            div.style.backgroundImage = '';

            if(data.type === 'image') {
                div.style.backgroundImage = `url('${data.content}')`;
                div.style.backgroundSize = data.bgSize;
                div.style.backgroundPosition = data.bgPos;
            } else {
                div.style.backgroundColor = data.content;
            }
        }

        // --- SELECTION ---
        function startDrag(e, index) {
            e.preventDefault();
            isDragging = true;
            dragStartIdx = index;
            if(!e.ctrlKey) clearSelection();
            
            if(currentMode === 'draw') addToSelection(index);
            else previewRectangle(index);
        }

        function onDrag(e, index) {
            if(!isDragging) return;
            if(currentMode === 'draw') addToSelection(index);
            else previewRectangle(index);
        }

        function endDrag() { isDragging = false; dragStartIdx = null; }

        function addToSelection(index) {
            if(!selectedIndices.has(index)) {
                selectedIndices.add(index);
                grid.children[index].classList.add('selected');
                updateUI();
            }
        }

        function previewRectangle(currIndex) {
            selectedIndices.forEach(idx => grid.children[idx]?.classList.remove('selected'));
            selectedIndices.clear();

            const startX = dragStartIdx % COLS;
            const startY = Math.floor(dragStartIdx / COLS);
            const currX = currIndex % COLS;
            const currY = Math.floor(currIndex / COLS);

            const minX = Math.min(startX, currX);
            const maxX = Math.max(startX, currX);
            const minY = Math.min(startY, currY);
            const maxY = Math.max(startY, currY);

            for(let y = minY; y <= maxY; y++) {
                for(let x = minX; x <= maxX; x++) {
                    const idx = y * COLS + x;
                    selectedIndices.add(idx);
                    grid.children[idx].classList.add('selected');
                }
            }
            updateUI();
        }

        function clearSelection() {
            selectedIndices.forEach(idx => grid.children[idx]?.classList.remove('selected'));
            selectedIndices.clear();
            updateUI();
        }

        function updateUI() {
            const count = selectedIndices.size;
            if(count > 0) {
                actionBar.classList.add('visible');
                document.getElementById('selCount').innerText = count;
                document.getElementById('costDisplay').innerText = count * COST_PER_PIXEL;
            } else {
                actionBar.classList.remove('visible');
            }
        }

        // --- PURCHASE ---
        function openModal() {
            const cost = selectedIndices.size * COST_PER_PIXEL;
            if(credits < cost) return alert("Insufficient Credits");
            
            document.getElementById('modalCost').innerText = cost;
            document.getElementById('imageOptions').classList.toggle('hidden', currentMode !== 'image');
            document.getElementById('drawOptions').classList.toggle('hidden', currentMode !== 'draw');
            document.getElementById('modalTitle').innerText = currentMode === 'image' ? 'Upload Photo' : 'Fill Color';
            
            document.getElementById('modal').classList.remove('hidden');
        }

        function closeModal() { document.getElementById('modal').classList.add('hidden'); }

        const toBase64 = file => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = reject;
        });

        async function confirmPurchase() {
            const cost = selectedIndices.size * COST_PER_PIXEL;
            if(credits < cost) return;

            let content, link;
            
            // MATH FOR IMAGE SLICING
            const indices = Array.from(selectedIndices);
            const xs = indices.map(i => i % COLS);
            const ys = indices.map(i => Math.floor(i / COLS));
            const minX = Math.min(...xs);
            const maxX = Math.max(...xs);
            const minY = Math.min(...ys);
            const maxY = Math.max(...ys);
            
            const spanX = maxX - minX + 1;
            const spanY = maxY - minY + 1;

            if(currentMode === 'image') {
                const urlVal = document.getElementById('urlInput').value.trim();
                link = document.getElementById('linkInput').value.trim();
                
                if(fileInput.files.length > 0) {
                    try { content = await toBase64(fileInput.files[0]); } catch(e) { return; }
                } else if(urlVal) {
                    content = urlVal;
                } else return alert("No image source");

            } else {
                content = document.getElementById('colorInput').value;
            }

            if(link && !link.startsWith('http')) link = 'https://' + link;

            credits -= cost;
            updateCredits();

            indices.forEach(idx => {
                const x = idx % COLS;
                const y = Math.floor(idx / COLS);
                const relX = x - minX;
                const relY = y - minY;

                const bgSize = `${spanX * 100}% ${spanY * 100}%`;
                const posX = spanX > 1 ? (relX / (spanX - 1)) * 100 : 0;
                const posY = spanY > 1 ? (relY / (spanY - 1)) * 100 : 0;
                const bgPos = `${posX}% ${posY}%`;

                gridData[idx] = {
                    type: currentMode,
                    content: content,
                    link: link,
                    bgSize: bgSize, 
                    bgPos: bgPos
                };
                
                if(grid.children[idx]) renderCell(grid.children[idx], gridData[idx]);
            });

            try {
                localStorage.setItem('w3_grid', JSON.stringify(gridData));
            } catch(e) { alert("Storage Full"); }

            closeModal();
            clearSelection();
        }

        init();
    </script>
</body>
</html>